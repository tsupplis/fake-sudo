#!/bin/sh
# sudo - A compatibility wrapper that maps sudo commands to doas or provides
#        equivalent behavior using sh when doas is not available
#
# This script attempts to translate common sudo options to doas equivalents
# or simulate the behavior when doas is not installed.

set -e

# Check if doas is available
have_doas=0
if command -v doas >/dev/null 2>&1; then
    have_doas=1
fi

# Function to show usage/help
show_help() {
    if [ "$have_doas" -eq 1 ]; then
        cat <<'EOF'
sudo - execute a command as another user (compatibility wrapper)

Usage: sudo [options] [command [arg ...]]

Mode: Using doas backend (privilege escalation enabled)

Common options:
  -h, --help              Display this help message
  -V, --version           Display version information
  -u user, --user=user    Run command as specified user (default: root)
  -s, --shell             Run shell as target user
  -i, --login             Run login shell as target user
  -n, --non-interactive   Non-interactive mode, fail if password required
  -b, --background        Run command in background
  -a style                Use specified authentication style
  -C config               Check doas configuration file
  -L, --clear-persist     Clear persisted authentication

Limited support options:
  -v, --validate          Update cached credentials (limited support)
  -k, --reset-timestamp   Invalidate cached credentials (limited support)
  -K, --remove-timestamp  Remove all cached credentials (limited support)
  -E, --preserve-env      Preserve user environment (warning: limited support)
  -g group, --group=group Run with specified group (warning: not supported by doas)
  -H, --set-home          Set HOME to target user's home (not implemented)
  -l, --list              List privileges (not implemented)

Note: This wrapper translates sudo options to doas equivalents.
EOF
    else
        cat <<'EOF'
sudo - execute a command as another user (compatibility wrapper)

Usage: sudo [options] [command [arg ...]]

Mode: Using shell backend (NO privilege escalation - development/testing mode)

Common options:
  -h, --help              Display this help message
  -V, --version           Display version information
  -s, --shell             Run shell (as current user)
  -i, --login             Run login shell (as current user)
  -b, --background        Run command in background

Ignored options (warnings will be shown):
  -u user, --user=user    Run as specified user (ignored: requires doas)
  -n, --non-interactive   Non-interactive mode (ignored: requires doas)
  -g group, --group=group Run with specified group (ignored: requires doas)
  -a style                Authentication style (ignored: requires doas)
  -C config               Check configuration (ignored: requires doas)
  -L, --clear-persist     Clear persisted auth (ignored: requires doas)
  -l, --list              List privileges (not implemented)
  -v, --validate          Validate credentials (ignored: requires doas)
  -k, --reset-timestamp   Reset timestamp (ignored: requires doas)
  -K, --remove-timestamp  Remove timestamp (ignored: requires doas)
  -E, --preserve-env      Preserve environment (ignored: requires doas)
  -H, --set-home          Set HOME (ignored: requires doas)
EOF
    fi
}

# Function to show version
show_version() {
    if [ "$have_doas" -eq 1 ]; then
        echo "sudo compatibility wrapper (using doas backend)"
        doas -V 2>/dev/null || echo "doas version: unknown"
    else
        echo "sudo compatibility wrapper (using sh backend)"
        echo "Version: 1.0.0"
    fi
}

# Initialize variables
opt_target_user="root"
opt_run_shell=0
opt_login_shell=0
opt_preserve_env=0
opt_set_home=0
opt_background=0
opt_non_interactive=0
opt_list_privileges=0
opt_validate=0
opt_reset_timestamp=0
opt_remove_timestamp=0
opt_target_group=""
opt_auth_style=""
opt_check_config=""
opt_clear_persist=0
command=""
command_args=""

# Parse arguments
while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)
            show_help
            exit 0
            ;;
        -V|--version)
            show_version
            exit 0
            ;;
        -u|--user)
            shift
            if [ $# -eq 0 ]; then
                echo "sudo: option requires an argument -- u" >&2
                exit 1
            fi
            opt_target_user="$1"
            shift
            ;;
        --user=*)
            opt_target_user="${1#--user=}"
            shift
            ;;
        -g|--group)
            shift
            if [ $# -eq 0 ]; then
                echo "sudo: option requires an argument -- g" >&2
                exit 1
            fi
            opt_target_group="$1"
            shift
            ;;
        --group=*)
            opt_target_group="${1#--group=}"
            shift
            ;;
        -s|--shell)
            opt_run_shell=1
            shift
            ;;
        -i|--login)
            opt_login_shell=1
            shift
            ;;
        -E|--preserve-env)
            opt_preserve_env=1
            shift
            ;;
        -H|--set-home)
            opt_set_home=1
            shift
            ;;
        -b|--background)
            opt_background=1
            shift
            ;;
        -n|--non-interactive)
            opt_non_interactive=1
            shift
            ;;
        -l|--list)
            opt_list_privileges=1
            shift
            ;;
        -v|--validate)
            opt_validate=1
            shift
            ;;
        -k|--reset-timestamp)
            opt_reset_timestamp=1
            shift
            ;;
        -K|--remove-timestamp)
            opt_remove_timestamp=1
            shift
            ;;
        -a)
            shift
            if [ $# -eq 0 ]; then
                echo "sudo: option requires an argument -- a" >&2
                exit 1
            fi
            opt_auth_style="$1"
            shift
            ;;
        -C)
            shift
            if [ $# -eq 0 ]; then
                echo "sudo: option requires an argument -- C" >&2
                exit 1
            fi
            opt_check_config="$1"
            shift
            ;;
        -L|--clear-persist)
            opt_clear_persist=1
            shift
            ;;
        --)
            shift
            command="$1"
            shift
            command_args="$*"
            break
            ;;
        -*)
            echo "sudo: unknown option: $1" >&2
            echo "Try 'sudo --help' for more information." >&2
            exit 1
            ;;
        *)
            command="$1"
            shift
            command_args="$*"
            break
            ;;
    esac
done

# Handle special operations that don't execute commands
if [ "$opt_clear_persist" -eq 1 ]; then
    if [ "$have_doas" -eq 1 ]; then
        exec doas -L
    else
        echo "sudo: -L option requires doas (not available)" >&2
        exit 1
    fi
fi

if [ "$opt_validate" -eq 1 ] || [ "$opt_reset_timestamp" -eq 1 ] || [ "$opt_remove_timestamp" -eq 1 ]; then
    if [ "$have_doas" -eq 1 ]; then
        # doas doesn't have exact equivalents, but we can try a no-op command
        if [ "$opt_remove_timestamp" -eq 1 ]; then
            doas -L 2>/dev/null || true
        fi
        echo "sudo: credential caching operations have limited support" >&2
    else
        echo "sudo: credential caching not supported without doas" >&2
    fi
    exit 0
fi

if [ "$opt_list_privileges" -eq 1 ]; then
    echo "sudo: -l option not implemented" >&2
    exit 1
fi

# Handle shell invocation
if [ "$opt_run_shell" -eq 1 ] || [ "$opt_login_shell" -eq 1 ]; then
    user_shell="${SHELL:-/bin/sh}"
    
    if [ "$have_doas" -eq 1 ]; then
        doas_args="-u $opt_target_user"
        [ "$opt_non_interactive" -eq 1 ] && doas_args="$doas_args -n"
        [ -n "$opt_auth_style" ] && doas_args="$doas_args -a $opt_auth_style"
        
        if [ "$opt_login_shell" -eq 1 ]; then
            exec doas $doas_args -s
        else
            exec doas $doas_args "$user_shell"
        fi
    else
        # Fallback: just run the shell (ignoring user switching)
        if [ "$opt_target_user" != "root" ] && [ "$opt_target_user" != "$(id -un)" ]; then
            echo "sudo: warning: cannot switch to user '$opt_target_user' without doas, running as current user" >&2
        fi
        exec "$user_shell"
    fi
fi

# No command specified
if [ -z "$command" ]; then
    echo "sudo: no command specified" >&2
    echo "Try 'sudo --help' for more information." >&2
    exit 1
fi

# Check config mode
if [ -n "$opt_check_config" ]; then
    if [ "$have_doas" -eq 1 ]; then
        exec doas -C "$opt_check_config" $command $command_args
    else
        echo "sudo: -C option requires doas (not available)" >&2
        exit 1
    fi
fi

# Execute command with doas
if [ "$have_doas" -eq 1 ]; then
    doas_args="-u $opt_target_user"
    [ "$opt_non_interactive" -eq 1 ] && doas_args="$doas_args -n"
    [ -n "$opt_auth_style" ] && doas_args="$doas_args -a $opt_auth_style"
    
    if [ -n "$opt_target_group" ]; then
        echo "sudo: warning: -g option not supported by doas, ignoring" >&2
    fi
    
    if [ "$opt_preserve_env" -eq 1 ]; then
        echo "sudo: warning: -E option has limited support with doas" >&2
    fi
    
    if [ "$opt_background" -eq 1 ]; then
        # shellcheck disable=SC2086
        doas $doas_args $command $command_args &
    else
        # shellcheck disable=SC2086
        exec doas $doas_args $command $command_args
    fi
else
    # Fallback implementation using plain sh (no user switching)
    if [ "$opt_target_user" != "root" ] && [ "$opt_target_user" != "$(id -un)" ]; then
        echo "sudo: warning: cannot switch to user '$opt_target_user' without doas, running as current user" >&2
    fi
    
    if [ -n "$opt_target_group" ]; then
        echo "sudo: warning: -g option not supported without doas" >&2
    fi
    
    # Execute the command directly
    if [ "$opt_background" -eq 1 ]; then
        # shellcheck disable=SC2086
        $command $command_args &
    else
        # shellcheck disable=SC2086
        exec $command $command_args
    fi
fi
